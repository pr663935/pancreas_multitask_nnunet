# Multi-Task Pancreas Segmentation and Lesion Subtype Classification with nnU-Net v2 ResEncM

This repository is the official implementation of *Multi-Task Pancreas CT: Segmentation + Lesion Subtype Classification*.  
It extends nnU-Net v2 with a custom classification head to jointly segment the pancreas and lesions while also classifying lesion subtype (0/1/2).

---

## Requirements

To install requirements:

```bash
pip install -r requirements.txt
```

**Environment details:**
- OS: Ubuntu 20.04/22.04 (tested)  
- Python: 3.10+  
- GPU: NVIDIA (≥ 12 GB VRAM recommended)  
- CUDA: 12.x (match your Torch build)  
- Torch: tested with 2.2.0+cu121

---

## Installation

Install nnU-Net v2 (editable) and this repo’s requirements:

```bash
git clone https://github.com/MIC-DKFZ/nnUNet.git
cd nnUNet
pip install -e .

# back to your project root
pip install -r requirements.txt
```

---

## Dataset Setup

Follow nnU-Net’s dataset convention:

```
/nnUNet_raw/Dataset501_Pancreas/
 ├── imagesTr/ (training images, e.g. case_0000.nii.gz)
 ├── labelsTr/ (training labels, pancreas/lesion masks)
 ├── imagesTs/ (test images)
 └── dataset.json (auto-generated during preprocessing)
```

Ensure data is in the correct folders before preprocessing.

---

## Preprocessing

```bash
nnUNetv2_plan_and_preprocess -d 501 -pl nnUNetPlannerResEncM
```

This writes plans/splits for Dataset 501.

---

## Training

**Custom trainer location (required):**
```
.../nnUNet/nnunetv2/training/nnUNetTrainer/trainer_with_classification.py
```
(Generated by the notebook cell or copied here manually.)


To train a single fold (e.g., fold 0) simply specify -f x (x being number of folds 0-5)  in the training command:
**Single fold (example: 0):**
```bash
nnUNetv2_train 501 3d_fullres 0   -p nnUNetResEncUNetMPlans   -tr TrainerWithClassification --npz
```

**5-fold CV:**
```bash
for f in 0 1 2 3 4; do
  nnUNetv2_train 501 3d_fullres $f     -p nnUNetResEncUNetMPlans     -tr TrainerWithClassification --npz
done
```

> Example compute: 1× A100 40GB (~2–3 days for all folds).  
> Observed on RTX PRO 6000: ~30 min for 23 epochs (single fold).

---

## Inference & Evaluation (No CLI)

**We do NOT use `nnUNetv2_predict` in this repo.**  
Run the notebook cell titled **“nnU‑Net‑style inference”** and update the paths at the top of the cell:

- `MODEL_DIR` → your trained fold (e.g. `/workspace/nnUNet_results/Dataset501_Pancreas/TrainerWithClassification__nnUNetResEncUNetMPlans__3d_fullres/fold_0`)
- `IMAGES_TS` → `/nnUNet_raw/Dataset501_Pancreas/imagesTs`
- `OUT_DIR` → output folder for predictions (e.g. `outputs/segmentation`)

The notebook will:
1) Load the trained ResEncM model (seg + classification head)  
2) Run sliding‑window inference on test images  
3) Save segmentation NIfTI to `OUT_DIR`  
4) Write lesion subtype predictions to:  
```
outputs/classification_predictions.csv
```

**Metrics (aligned with *Metrics Reloaded*):**
- **Segmentation:** Dice Similarity Coefficient (DSC)  
- **Classification:** F1, Confusion Matrix

---

## Pre-trained Models

- **ResEncM Fold‑0 Model**
  Trained on Dataset501 Pancreas CT with the classification head.

Expected performance:
- Pancreas DSC ≈ 0.84  
- Lesion DSC ≈ 0.53  
- Subtype macro‑F1 ≈ 0.48

---

## Results

| Model name       | Pancreas DSC | Lesion DSC | Subtype Macro‑F1 | Balanced Accuracy |
|------------------|--------------|------------|------------------|-------------------|
| ResEncM (fold_0) | 0.84         | 0.53       | 0.48             | 0.41              |

Visual examples (GT vs. prediction overlays) are in `results_examples/`.
